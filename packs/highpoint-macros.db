{"name":"Generate Dungeon Encounters","type":"script","author":"GK1bxcUGIgTnMfUa","img":"icons/svg/combat.svg","scope":"global","command":"async function GenerateDungeon($html){\n\n    console.log(\"Generate Dungeon Encounter\")\n    //get inputs from form\n    const pLevel = parseInt($html.find('[name=\"partylevel\"]')[0].value);\n    const ebudget = parseInt($html.find('[name=\"encounterbudget\"]')[0].value);\n    var etheme = $html.find('[name=\"creaturetheme\"]')[0].value;\n\n    console.log(\"party level: \"+pLevel+ \" encounter budget: \"+ebudget+\" theme \"+etheme);\n    \n    //game.packs.forEach(e => console.log(e));\n    //load the compendium and make sure it is indexed for reference.(loads into memory)\n    const creature_pack = game.packs.get(\"highpoint.highpoint-random-creatures-tables\");\n    //console.log(creature_pack);\n    creature_pack.getIndex();\n    //humanoidsLVL1ID = creature_pack.index.find(t => t.name === 'HP Humanoid Level 01')._id;\n    //creature_pack.getDocument(humanoidsLVL1ID).then(table => table.draw());\n\n    //define the level adjustments per XP allocation. \n    const encounterBudget40Allocations = [[0],[-1,-4],[-2,-2],[-2,-3,-4]];\n    const encounterBudget60Allocations = [[0,-2],[1],[-1,-1],[-2,-2,-2]];\n    const encounterBudget80Allocations = [[2],[1,-2],[0,0],[0,-2,-2],[-1,-3,-3,-4],[-3,-3,-1,-2]];\n    const encounterBudget120Allocations = [[3],[2,0],[2,-2,-2],[1,1],[1,0,-2],[1,-1,-1],[0,0,0],[0,-1,-1,-2]];\n    const encounterBudget160Allocations = [[4,-2],[3,-2,-2],[2,2],[1,1,0],[0,0,0,0],[1,0,-1,-1]];\n\n    //define the id of the roll tables to look up into get creatures. \n    const humanoidRolltables = ['HP Humanoid Level -01 - 00','HP Humanoid Level 01','HP Humanoid Level 02','HP Humanoid Level 03','HP Humanoid Level 04','HP Humanoid Level 05','HP Humanoid Level 06','HP Humanoid Level 07','HP Humanoid Level 08-09','HP Humanoid Level 08-09','HP Humanoid Level 10-12','HP Humanoid Level 10-12','HP Humanoid Level 10-12'];\n    const aberrationRolltables = ['HP Aberration Or Fiend 00-02','HP Aberration Or Fiend 00-02','HP Aberration Or Fiend 00-02','HP Aberration Or Fiend 03-05','HP Aberration Or Fiend 03-05','HP Aberration Or Fiend 03-05','HP Aberration Or Fiend 06-08','HP Aberration Or Fiend 06-08','HP Aberration Or Fiend 06-08','HP Aberration Or Fiend 09-11','HP Aberration Or Fiend 09-11','HP Aberration Or Fiend 09-11','HP Aberration Or Fiend 09-11',]\n    const animalRolltables = ['HP Animals Level -01-00','HP Animals Level 01','HP Animals Level 02','HP Animals Level 03','HP Animals Level 04','HP Animals Level 05','HP Animals Level 06-07','HP Animals Level 06-07','HP Animals Level 08-09','HP Animals Level 08-09','HP Animals Level 10-12','HP Animals Level 10-12','HP Animals Level 10-12'];\n    const feyRolltables = ['HP Fey Level 00-02','HP Fey Level 00-02','HP Fey Level 00-02','HP Fey Level 03-05','HP Fey Level 03-05','HP Fey Level 03-05','HP Fey Level 06-08','HP Fey Level 06-08','HP Fey Level 06-08','HP Fey Level 09-11','HP Fey Level 09-11','HP Fey Level 09-11','HP Fey Level 09-11'];\n    const plantRolltables = ['HP Plant Fungus Ooze Level -01-00','HP Plant Fungus Ooze Level 01-03','HP Plant Fungus Ooze Level 01-03','HP Plant Fungus Ooze Level 01-03','HP Plant Fungus Ooze Level 04-06','HP Plant Fungus Ooze Level 04-06','HP Plant Fungus Ooze Level 04-06','HP Plant Fungus Ooze Level 07-09','HP Plant Fungus Ooze Level 07-09','HP Plant Fungus Ooze Level 07-09','HP Plant Fungus Ooze Level 10-12','HP Plant Fungus Ooze Level 10-12','HP Plant Fungus Ooze Level 10-12'];\n    const undeadRolltables = ['HP Undead Level 00', 'HP Undead Level 01-02','HP Undead Level 01-02','HP Undead Level 03-04','HP Undead Level 03-04','HP Undead Level 05-06','HP Undead Level 05-06','HP Undead Level 07-08','HP Undead Level 07-08','HP Undead Level 09-10','HP Undead Level 09-10','HP Undead Level 11-12','HP Undead Level 11-12'];\n\n\n    var selectedCreatureRollTables = humanoidRolltables;\n    var creaturesLevelsArray = [];\n    var selectedEncounterBudgetAllocations;\n    \n    //randomly set the theme. \n    if(etheme == \"any\")\n    {\n        //randomly select a theme\n        var randomselectedtheme = Math.floor(Math.random()*6);\n        if(randomselectedtheme == 1){\n            etheme = \"aberration\";\n        }else if(randomselectedtheme == 2){\n            etheme = \"animals\";\n        }else if(randomselectedtheme ==3){\n            etheme = \"fey\";\n        }else if(randomselectedtheme == 4){\n            etheme = \"plant\";\n        }else if(randomselectedtheme == 5){\n            etheme = \"undead\";\n        }else{\n            etheme = \"humanoid\";\n        }\n\n    }\n    \n    //now set the rolltable look up based on the theme\n    if(etheme == \"humanoid\")    \n    {\n        selectedCreatureRollTables = humanoidRolltables;\n    }\n    else if(etheme ==\"aberration\")\n    {\n        selectedCreatureRollTables = aberrationRolltables;\n    }\n    else if(etheme == \"animals\")\n    {\n        selectedCreatureRollTables = animalRolltables;\n    }\n    else if(etheme == \"fey\")\n    {\n        selectedCreatureRollTables = feyRolltables;\n    }\n    else if(etheme == \"plant\")\n    {\n        selectedCreatureRollTables = plantRolltables;\n    }\n    else if(etheme == \"undead\")\n    {\n        selectedCreatureRollTables = undeadRolltables;\n    }\n    \n    \n    \n    //set the look up list for encounter make up.\n    if (ebudget <=40)\n    {\n        selectedEncounterBudgetAllocations = encounterBudget40Allocations;\n        console.log(\"Selected encounter level 40\");\n    }\n    else if (ebudget<=60)\n    {\n        selectedEncounterBudgetAllocations = encounterBudget60Allocations;\n        console.log(\"Selected encounter level 60\");\n    }\n    else if(ebudget<=80)\n    {\n        selectedEncounterBudgetAllocations = encounterBudget80Allocations;\n        console.log(\"Selected encounter level 80\");\n    }\n    else if(ebudget<=120)\n    {\n        selectedEncounterBudgetAllocations = encounterBudget120Allocations;\n        console.log(\"Selected encounter level 120\");\n    }\n    else\n    {\n        selectedEncounterBudgetAllocations = encounterBudget160Allocations;\n        console.log(\"Selected encounter level 160\");\n    }\n\n    console.log(selectedEncounterBudgetAllocations);\n\n    //get the random values to grab the creatures. \n    const encounterBudgetArrayIndex = Math.floor(Math.random()*selectedEncounterBudgetAllocations.length);\n    const creatureBudgetArray = selectedEncounterBudgetAllocations[encounterBudgetArrayIndex];\n\n\n    //print out that we are getting creatures for a room. \n    ChatMessage.create({\n        content : \"Creating encounter for room at level: \"+pLevel+\" with encounter budget of : \"+ebudget+ \" theme:  \"+etheme\n    });\n    \n    //get the creatures from the rolltable and display them based on the random budget allocation. \n    for(let i = 0; i<creatureBudgetArray.length;i++)\n    {\n        creatureLevel = creatureBudgetArray[i]+pLevel;\n        if(creatureLevel<0){creatureLevel = 0;}\n        if(creatureLevel>12){creatureLevel = 12;}\n\n        console.log(\"Getting level \"+creatureLevel+\" creature from: \"+selectedCreatureRollTables[creatureLevel]);\n\n        creatureLVLID = creature_pack.index.find(t => t.name === selectedCreatureRollTables[creatureLevel])._id;\n        creature_pack.getDocument(creatureLVLID).then(table => table.draw());\n    }\n\n}\n    \n    \n    let d = new Dialog({\n        title: \"Test Dialog\",\n        content: `\n        <p>Select Party Level and Number of Rooms.</p>\n            <form>\n                <div>\n                    <label>Select Party Level:</label> \n                    <select id=\"partylevel\" name=\"partylevel\">\n                        <option>1</option>\n                        <option>2</option>\n                        <option>3</option>\n                        <option>4</option>\n                        <option>5</option>\n                        <option>6</option>\n                        <option>7</option>\n                        <option>8</option>\n                        <option>9</option>\n                        <option>10</option>\n                        <option>11</option>\n                    </select>\n                </div>\n                <div>\n                    <label>Select Number of Rooms:</label> \n                    <select id=\"encounterbudget\" name=\"encounterbudget\">\n                        <option>80</option>\n                        <option>40</option>\n                        <option>60</option>                        \n                        <option>120</option>\n                        <option>160</option>\n                    </select>\n                </div>\n                <div>\n                    <label>Theme:</label> \n                    <select id=\"creaturetheme\" name=\"creaturetheme\">\n                        <option>any</option>\n                        <option>humanoid</option>\n                        <option>aberration</option>                        \n                        <option>animals</option>\n                        <option>fey</option>\n                        <option>plant</option>\n                        <option>undead</option>\n                    </select>\n                </div>                \n            </form>\n        `\n        ,\n        buttons: {\n         one: {\n          icon: '<i class=\"fas fa-check\"></i>',\n          label: \"Generate\",\n          callback: GenerateDungeon\n         }         \n        },\n        default: \"one\",\n        render: html => console.log(\"Register interactivity in the rendered dialog\"),\n        close: html => console.log(\"This always is logged no matter which option is chosen\")\n       });\n       d.render(true);","folder":null,"sort":0,"permission":{"default":0,"GK1bxcUGIgTnMfUa":3},"flags":{"core":{"sourceId":"Macro.TpOCEfkQSBMPDLW5"}},"_id":"cA3xNAXX94hVSrP0"}
